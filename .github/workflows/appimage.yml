name: Build PX4 SITL AppImage

on:
  pull_request:
    branches:
      - main

jobs:
  build-appimage:
    runs-on: ubuntu-latest
    container:
      image: px4io/px4-dev:v1.16.0-rc1-258-g0369abd556
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Git ownership workaround
        run: git config --system --add safe.directory '*'

      - name: Install PX4 dependencies
        run: |
          sudo apt-get update
          bash ./Tools/setup/ubuntu.sh --no-nuttx --no-sim-tools

      - name: Install appimagetool
        run: |
          wget -O appimagetool-x86_64.AppImage \
            https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Build PX4 SITL and AppImage
        run: |
          make appimage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: px4-sitl-appimage
          path: build/*.AppImage
